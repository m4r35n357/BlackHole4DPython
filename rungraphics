#!/bin/sh
set -x
ic=$1
time=$2
timeStep=$3
shift 3
coordinates=$*

simVala='./bh3d'
simPython='./bh3d.py'
dataFile='/tmp/data'

# Pretty-print the parameter file
jq . $ic

# Run the simulator
echo -n "Simulating "
if [ -f $simVala ]
then
    echo -n "with $simVala . . . "
    $simVala <$ic 2>errors | ./finterp.py $timeStep >$datafile
else
    echo -n "with $simPython . . . "
    $simPython <$ic 2>errors | ./finterp.py $timeStep >$datafile
fi
echo "Done!"

# Plot the orbit
case $(uname -m) in
    armv7l) ./filegraphics-pi.py $dataFile $ic;;
    x86_64) ./filegraphics.py $(jq .M $ic) $(jq .a $ic) &
            # Plot potential, coordinates/velocities (optional) and errors
            ./filepotential.py potential &
            for coordinate in $coordinates
            do
            	./phase.py $dataFile $time $nPoints $coordinate &
            	./interpolate.py $dataFile $time $nPoints $coordinate &
            done
	filesize=$(wc -l $datafile)
            ./errorchart.py <$dataFile $(expr $filesize / 1000) &;;
esac

